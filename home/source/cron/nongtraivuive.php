<?php
# 农场刷草/虫子/大便/蚊子
# Modify by seaif@zealv.com

if(!defined('IN_UCHOME')) {
	exit('Access Denied');
}

//compatibility for PHP Version < 5.2.1
if(version_compare(PHP_VERSION, '5.2.1', '<')) {
	include_once(S_ROOT ."./happyfarm/include/json.php");
}

//农场刷草和虫子
$cropstime = array(
				"1" => array(14400,28800,46800,64800,86400,2000000000), 
				"2" => array(7200,14400,25200,35995,36000,2000000000), 
				"3" => array(7200,18000,32400,46795,46800,2000000000), 
				"4" => array(7200,14400,25200,36000,50400,2000000000), 
				"5" => array(7200,14400,25200,39600,54000,2000000000), 
				"6" => array(7200,18000,28800,43200,57600,2000000000), 
				"7" => array(7200,18000,32400,46800,61200,2000000000), 
				"8" => array(10800,21600,32400,46800,64800,2000000000), 
				"9" => array(10800,25200,39600,54000,72000,2000000000), 
				"10" => array(10800,25200,43200,61200,79200,2000000000), 
				"11" => array(14400,28800,43200,57600,75600,2000000000), 
				"13" => array(28800,61200,93600,129600,165600,2000000000), 
				"14" => array(14400,32400,54000,75600,100800,2000000000), 
				"15" => array(18000,39600,61200,86400,111600,2000000000), 
				"18" => array(28800,57600,86400,118800,151200,2000000000), 
				"19" => array(25200,50400,75600,104400,133200,2000000000), 
				"23" => array(36000,72000,108000,147600,187200,2000000000), 
				"26" => array(39600,82800,126000,172800,219600,2000000000), 
				"27" => array(43200,90000,136800,183600,230400,2000000000), 
				"29" => array(36000,75600,115200,154800,198000,2000000000), 
				"31" => array(39600,82800,126000,172800,219600,2000000000), 
				"33" => array(46800,97200,147600,198000,252000,2000000000), 
				"34" => array(50400,100800,151200,205200,259200,2000000000), 
				"35" => array(54000,108000,165600,219600,277200,2000000000), 
				"38" => array(28800,61200,93600,129600,165600,2000000000), 
				"39" => array(28800,61200,93600,129600,165600,2000000000), 
				"40" => array(7200,14400,21600,28795,28800,2000000000), 
				"41" => array(10800,21600,32400,46800,64800,2000000000), 
				"42" => array(18000,39600,61200,86400,111600,2000000000), 
				"44" => array(18000,39600,61200,86400,111600,2000000000), 
				"45" => array(28800,61200,93600,129600,165600,2000000000), 
				"46" => array(18000,39600,61200,86400,111600,2000000000), 
				"47" => array(18000,39600,61200,86400,111600,2000000000), 
				"48" => array(18000,39600,61200,86400,111600,2000000000), 
				"49" => array(28800,57600,86400,118800,151200,2000000000),
				"50" => array(25200,50400,79200,108000,108000,2000000000), 
				"51" => array(7200,18000,28800,43200,57600,2000000000), 
				"53" => array(18000,39600,61200,86400,111600,2000000000), 
				"54" => array(21600,43200,64800,90000,115200,2000000000), 
				"55" => array(28800,57600,86400,118800,151200,2000000000), 
				"56" => array(18000,39600,61200,86400,111600,2000000000), 
				"57" => array(18000,39600,61200,86400,111600,2000000000), 
				"58" => array(18000,39600,61200,86400,111600,2000000000), 
				"59" => array(7200,14400,25200,36000,50400,2000000000), 
				"60" => array(7200,14400,25200,36000,50400,2000000000), 
				"61" => array(7200,14400,25200,36000,50400,2000000000), 
				"62" => array(14400,28800,46800,64800,82800,2000000000), 
				"63" => array(18000,39600,61200,86400,111600,2000000000),
				"67" => array(21600,43200,68400,97200,126000,2000000000), 
				"68" => array(18000,39600,61200,86400,111600,2000000000),
				"70" => array(14400,32400,54000,75600,100800,2000000000), 
				"72" => array(28800,61200,93600,129600,165600,2000000000),
				"74" => array(18000,39600,61200,86400,111600,2000000000), 
				"75" => array(18000,39600,61200,86400,111600,2000000000), 
				"76" => array(18000,39600,61200,86400,111600,2000000000),
				"77" => array(18000,39600,61200,86400,111600,2000000000), 
				"78" => array(18000,39600,61200,86400,111600,2000000000), 
				"79" => array(18000,39600,61200,86400,111600,2000000000), 
				"80" => array(18000,39600,61200,86400,111600,2000000000), 
				"81" => array(7200,14400,25200,36000,46800,2000000000), 
				"82" => array(18000,39600,75600,104400,133200,2000000000), 
				"92" => array(28800,61200,93600,129600,165600,2000000000), 
				"101" => array(39600,82800,126000,172800,219600,2000000000), 
				"102" => array(43200,90000,136800,183600,230400,2000000000), 
				"103" => array(10800,25200,39600,54000,72000,2000000000), 
				"104" => array(14400,28800,43200,57600,75600,2000000000), 
				"105" => array(7200,18000,32400,46800,61200,2000000000),
				"106" => array(36000,72000,108000,147600,187200,2000000000),
				"107" => array(21600,43200,64800,90000,115200,2000000000),
				"108" => array(21600,43200,64800,90000,115200,2000000000),
				"109" => array(43200,90000,136800,183600,230400,2000000000),
				"111" => array(14400,32400,54000,75600,100800,2000000000), 
				"112" => array(18000,39600,61200,86400,111600,2000000000), 
				"114" => array(28800,57600,86400,118800,151200,2000000000)
);

$query = $_SGLOBAL['db']->query('SELECT uid,status FROM '.tname('happyfarm_nc'));
$query1 = $_SGLOBAL['db']->query('SELECT tianqi FROM '.tname('happyfarm_config'));

	while ($value = $_SGLOBAL['db']->fetch_array($query)) {
				$list[] = $value;
				}
	while ($value1 = $_SGLOBAL['db']->fetch_array($query1)) {
				$list1[] = $value1;
				}

foreach ($list as $userparameter) {
	$farm= json_decode($userparameter[status]);
	foreach ($farm->farmlandstatus as $value){
		if(($_SGLOBAL['timestamp']-$value->q)<$cropstime[$value->a][4])
		{
			$suiji=mt_rand(1,50);
			if($value->f==0)
			{
				if ($suiji<10)
				{
					if ($suiji<4)
					{
						if ($suiji<2)
						{
							$value->f=3;
							$fp = array($_SGLOBAL['timestamp']=>2,($_SGLOBAL['timestamp']+1)=>2,($_SGLOBAL['timestamp']+2)=>2);
						}
						else
						{
							$value->f=2;
							$fp = array($_SGLOBAL['timestamp']=>2,($_SGLOBAL['timestamp']+1)=>2);
						}
					}
					else
					{
						$value->f=1;
						$fp = array($_SGLOBAL['timestamp']=>2);
					}
				}
			}
			$suiji=mt_rand(0,50);
			if($value->g==0 && ($_SGLOBAL['timestamp']-$value->q)>$cropstime[$value->a][2])
			{
				if ($suiji<10)
				{
					if ($suiji<4)
					{
						if ($suiji<2)
						{
							$value->g=3;
							
							$gp = array(($_SGLOBAL['timestamp']+10)=>1,($_SGLOBAL['timestamp']+11)=>1,($_SGLOBAL['timestamp']+12)=>1);
						}
						else
						{
							$value->g=2;
							$gp = array(($_SGLOBAL['timestamp']+10)=>1,($_SGLOBAL['timestamp']+11)=>1);
						}
					}
					else
					{
						$value->g=1;
						$gp = array(($_SGLOBAL['timestamp']+10)=>1);
					}
				}
			}
			if(($_SGLOBAL['timestamp']-$value->q)<$cropstime[$value->a][4])
				{
					$suiji=mt_rand(0,50);
					if ( $list1[0][tianqi]  == 1 )
					{
						if($value->h==1)
						{
							if ($suiji<7)
							{
								$value->h=0;
								$hp = array(($_SGLOBAL['timestamp']+20)=>3);
							}
						}
					}
				}
				$farm_p = array();
				if($fp){
				$farm_p = $farm_p+$fp;
	}
				if($gp){
				$farm_p = $farm_p+$gp;
				}
				if($hp){
				$farm_p = $farm_p+$hp;
				}
				unset($fp);
				unset($gp);
				unset($hp);
				if($farm_p){
					$value->p = $farm_p;
				}
	}
	}
	$farm=json_encode($farm);
	$_SGLOBAL['db']->query("UPDATE ".tname('happyfarm_nc')." set status='".$farm."' where uid=".$userparameter[uid]);
}


//牧场大便
$suiji = rand(1,2);
$_SGLOBAL['db']->query("UPDATE ".tname('happyfarm_mc')." set dabian=dabian+".$suiji." where dabian<16");


//牧场蚊子
$query1 = $_SGLOBAL['db']->query("select bad from ".tname('happyfarm_mc'));
while ($value = $_SGLOBAL['db']->fetch_array($query1)) {
	if($value[bad] == ''){
		$add_bad = '0,0';
	} else {
		$bad_array = explode(',',$value[bad]);
		$bad_array_count = count($bad_array);
		if($bad_array_count <8){
			$add_bad = $value[bad].',0';
		} else{
			exit();
		}
	}
	$_SGLOBAL['db']->query("UPDATE ".tname('happyfarm_mc')." set bad='".$add_bad."'");
}

?>